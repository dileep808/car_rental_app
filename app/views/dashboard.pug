//- dashboard.pug
doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Fleet Dashboard | Velocity Rentals
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css")
    link(rel="stylesheet", href="/home.css")
    link(rel="stylesheet", href="/dashboard.css")
  include sidebar.pug
  body
    - const m = metrics || {};
    - const money = (v) => `£${Number(v || 0).toLocaleString('en-GB', { maximumFractionDigits: 0 })}`;
    - const fmtDate = (v) => {
    -   if (!v) return '—';
    -   const d = new Date(v);
    -   return isNaN(d.getTime()) ? v : d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    - };
    - const searchTerm = search || '';

    .sidebar-shell
      +sidebar('dashboard')

      main.sidebar-content.dashboard
        if error
          .error-banner Unable to load latest data: #{error}

        section.hero#overview
          .container
            .hero-content.dashboard-hero
              .eyebrow Live Overview
              h1 Fleet dashboard
              p Track availability, active bookings, pickups, returns, and revenue at a glance.
              form.search-bar(action="/dashboard", method="get")
                input(type="text", name="search", placeholder="Search bookings or fleet...", value=searchTerm)
                button.btn.btn-primary(type="submit") Search
                if searchTerm
                  a.btn.btn-outline(href="/dashboard") Clear
              .quick-actions
                a.btn.btn-primary(href="#bookings") View bookings
                a.btn.btn-outline(href="#fleet") Manage fleet
              if searchTerm
                p.search-hint Showing results for "#{searchTerm}"

        section#stats
          .container
            .section-title
              h2 Key metrics
            .stats-grid
              .stat-card
                .stat-label Total cars
                .stat-value= m.total_cars || 0
                .stat-trend.text-positive
                  i.fas.fa-car
                  span Fleet size stable
              .stat-card
                .stat-label Available now
                .stat-value= m.cars_available || 0
                .stat-trend.text-positive
                  i.fas.fa-check-circle
                  span Ready to rent
              .stat-card
                .stat-label Active bookings
                .stat-value= m.active_bookings || 0
                .stat-trend.text-warning
                  i.fas.fa-clock
                  span Monitor returns
              .stat-card
                .stat-label Pickups today
                .stat-value= m.pickups_today || 0
                .stat-trend
                  i.fas.fa-calendar-day
                  span Confirm keys
              .stat-card
                .stat-label Returns today
                .stat-value= m.returns_today || 0
                .stat-trend
                  i.fas.fa-undo
                  span Prep inspections
              .stat-card
                .stat-label Revenue (MTD)
                .stat-value= money(m.revenue_this_month || 0)
                .stat-trend.text-positive
                  i.fas.fa-arrow-up
                  span Closed from completed

        // ===== BOOKINGS =====
        section
          .container
            .section-title
              h2 Active Bookings

            .card
              table.data-table
                thead
                  tr
                    th Booking
                    th Car
                    th Customer
                    th Status
                    th Start
                    th End
                    th Total
                    th Action
                tbody
                  if bookings && bookings.length
                    each b in bookings
                      tr
                        td #{'#' + b.id}
                        td #{b.make} #{b.model} (#{b.year})
                        td #{b.customer}
                        td
                          span.badge= b.status
                        td #{b.start_date}
                        td #{b.end_date}
                        td £#{b.total_price}
                        td
                          a.btn.btn-outline(href=`/agent/bookings/${b.id}`) Manage
                  else
                    tr
                      td(colspan="8") No bookings found.

        section#fleet
          .container
            .section-title
              h2 Fleet status
              p Inventory split by availability and location.
              a.btn.btn-primary(href="/cars/add") + Add Car

            .card
              table.data-table
                thead
                  tr
                    th Car
                    th Location
                    th Rate / day
                    th Status
                    th Actions
                tbody
                  if fleet && fleet.length
                    each car in fleet
                      - const badgeClass = (() => { const s = (car.status || '').toLowerCase(); if (s === 'available') return 'badge-available'; if (s === 'maintenance') return 'badge-maintenance'; return 'badge-booked'; })();
                      tr
                        td #{car.make} #{car.model} (#{car.year})
                        td #{car.location || '—'}
                        td= money(car.daily_rate)
                        td
                          span(class=`badge ${badgeClass}`)= car.status || '—'
                        td
                          a.btn.btn-outline(href=`/details/${car.id}`) View
                          a.btn.btn-outline(href=`/cars/edit/${car.id}`) Edit
                          form(
                            method="post",
                            action=`/cars/delete/${car.id}`,
                            style="display:inline"
                          )
                            button.btn.btn-danger(
                              type="submit",
                              onclick="return confirm('Delete this car?')"
                            ) Delete
                  else
                    tr
                      td(colspan="5") No cars found.

    footer
      .container.footer-meta
        span Velocity Rentals
